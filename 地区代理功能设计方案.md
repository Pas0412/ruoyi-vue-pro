# 地区代理功能设计方案

## 1. 功能概述

基于现有分销逻辑，设计并实现一个地区代理功能：
- 代理分为省、市、县（区）三级，使用邮政编码代表地区
- 每个用户只能成为一个地区的代理，不能跨级或同级兼任
- 提供后台接口编辑用户的代理等级和地区选择
- 管理后台需有类似分销的查询和设置页面
- 将分佣逻辑集成到订单中，根据地址向对应地区的区、市、省三级代理分佣
- 商品ID为643的会员商品不参与地区代理分佣

## 2. 数据库设计

### 2.1 地区代理用户表 (trade_area_agent_user)

```sql
CREATE TABLE `trade_area_agent_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '编号',
  `user_id` bigint NOT NULL COMMENT '用户编号',
  `area_id` int NOT NULL COMMENT '代理地区编号（对应area.csv中的id）',
  `area_level` tinyint NOT NULL COMMENT '代理等级：2-省级，3-市级，4-县区级',
  `area_name` varchar(100) NOT NULL COMMENT '地区名称',
  `parent_area_id` int NULL DEFAULT NULL COMMENT '上级地区编号',
  `agent_enabled` bit(1) NOT NULL DEFAULT b'1' COMMENT '是否启用代理资格',
  `agent_time` datetime NULL DEFAULT NULL COMMENT '成为代理时间',
  `commission_price` int NOT NULL DEFAULT 0 COMMENT '可用佣金（分）',
  `frozen_price` int NOT NULL DEFAULT 0 COMMENT '冻结佣金（分）',
  `creator` varchar(64) NULL DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) NULL DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `uk_user_id` (`user_id`) USING BTREE COMMENT '用户唯一约束',
  UNIQUE KEY `uk_area_id` (`area_id`) USING BTREE COMMENT '地区唯一约束',
  INDEX `idx_area_level` (`area_level`) USING BTREE,
  INDEX `idx_parent_area_id` (`parent_area_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '地区代理用户表';
```

### 2.2 地区代理佣金记录表 (trade_area_agent_record)

```sql
CREATE TABLE `trade_area_agent_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '编号',
  `user_id` bigint NOT NULL COMMENT '代理用户编号',
  `area_id` int NOT NULL COMMENT '代理地区编号',
  `area_level` tinyint NOT NULL COMMENT '代理等级：2-省级，3-市级，4-县区级',
  `biz_id` varchar(64) NOT NULL DEFAULT '' COMMENT '业务编号（订单号等）',
  `biz_type` tinyint NOT NULL DEFAULT 1 COMMENT '业务类型：1-订单，2-提现',
  `title` varchar(64) NOT NULL DEFAULT '' COMMENT '标题',
  `price` int NOT NULL DEFAULT 0 COMMENT '佣金金额（分）',
  `total_price` int NOT NULL DEFAULT 0 COMMENT '当前总佣金（分）',
  `description` varchar(500) NOT NULL DEFAULT '' COMMENT '说明',
  `status` tinyint NOT NULL DEFAULT 0 COMMENT '状态：0-待结算，1-已结算，2-已取消',
  `frozen_days` int NOT NULL DEFAULT 0 COMMENT '冻结时间（天）',
  `unfreeze_time` datetime NULL DEFAULT NULL COMMENT '解冻时间',
  `source_user_id` bigint NOT NULL DEFAULT 0 COMMENT '来源用户编号（下单用户）',
  `order_area_id` int NULL DEFAULT NULL COMMENT '订单收货地区编号',
  `creator` varchar(64) NULL DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) NULL DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`) USING BTREE,
  INDEX `idx_user_id` (`user_id`) USING BTREE,
  INDEX `idx_biz` (`biz_type`, `biz_id`) USING BTREE,
  INDEX `idx_status` (`status`) USING BTREE,
  INDEX `idx_area_level` (`area_level`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '地区代理佣金记录表';
```

### 2.3 地区代理配置表 (trade_area_agent_config)

```sql
CREATE TABLE `trade_area_agent_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '编号',
  `area_level` tinyint NOT NULL COMMENT '代理等级：2-省级，3-市级，4-县区级',
  `commission_percent` decimal(5,2) NOT NULL DEFAULT 0.00 COMMENT '佣金比例（%）',
  `frozen_days` int NOT NULL DEFAULT 0 COMMENT '佣金冻结天数',
  `enabled` bit(1) NOT NULL DEFAULT b'1' COMMENT '是否启用',
  `creator` varchar(64) NULL DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) NULL DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT 0 COMMENT '租户编号',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `uk_area_level` (`area_level`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '地区代理配置表';
```

### 2.4 地区数据表 (system_area)

```sql
CREATE TABLE `system_area` (
  `id` int NOT NULL COMMENT '地区编号',
  `name` varchar(100) NOT NULL COMMENT '地区名称',
  `type` tinyint NOT NULL COMMENT '地区类型：1-国家，2-省，3-市，4-县区',
  `parent_id` int NOT NULL DEFAULT 0 COMMENT '父级编号',
  `creator` varchar(64) NULL DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) NULL DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  PRIMARY KEY (`id`) USING BTREE,
  INDEX `idx_parent_id` (`parent_id`) USING BTREE,
  INDEX `idx_type` (`type`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '地区数据表';
```

## 3. 核心功能模块

### 3.1 地区代理用户管理
- AreaAgentUserDO：地区代理用户数据对象
- AreaAgentUserService：地区代理用户服务
- AreaAgentUserController：地区代理用户控制器

### 3.2 地区代理佣金管理
- AreaAgentRecordDO：地区代理佣金记录数据对象
- AreaAgentRecordService：地区代理佣金记录服务
- AreaAgentRecordController：地区代理佣金记录控制器

### 3.3 地区代理配置管理
- AreaAgentConfigDO：地区代理配置数据对象
- AreaAgentConfigService：地区代理配置服务
- AreaAgentConfigController：地区代理配置控制器

### 3.4 地区数据管理
- SystemAreaDO：地区数据对象
- SystemAreaService：地区数据服务
- SystemAreaController：地区数据控制器

### 3.5 订单地区代理分佣处理
- TradeAreaAgentOrderHandler：订单地区代理处理器

## 4. 分佣逻辑

### 4.1 分佣触发时机
- 订单支付成功后触发
- 参考现有的TradeBrokerageOrderHandler实现

### 4.2 分佣计算逻辑
1. 根据订单收货地址的area_id查找对应的县区、市、省三级地区
2. 查找每个级别是否有对应的代理用户
3. 根据配置的佣金比例计算各级代理应得佣金
4. 排除商品ID为643的会员商品
5. 创建佣金记录并更新代理用户佣金

### 4.3 佣金计算公式
```
代理佣金 = 订单实付金额 × 对应等级佣金比例
```

## 5. 接口设计

### 5.1 管理后台接口
- 地区代理用户管理：增删改查、启用禁用
- 地区代理配置管理：佣金比例设置、冻结天数设置
- 地区代理佣金记录查询：分页查询、统计分析
- 地区数据查询：省市县三级联动

### 5.2 用户端接口
- 查询个人代理信息
- 查询代理佣金记录
- 代理佣金提现申请

## 6. 实现步骤

1. 创建数据库表结构
2. 导入地区数据到system_area表
3. 实现地区数据管理功能
4. 实现地区代理用户管理功能
5. 实现地区代理配置管理功能
6. 实现地区代理佣金记录功能
7. 实现订单地区代理分佣逻辑
8. 实现管理后台页面
9. 实现用户端页面
10. 测试验证功能

## 7. 注意事项

1. 每个用户只能成为一个地区的代理
2. 每个地区只能有一个代理
3. 商品ID为643的会员商品不参与分佣
4. 佣金计算需要考虑冻结期
5. 需要防止重复分佣
6. 需要考虑订单退款时的佣金处理